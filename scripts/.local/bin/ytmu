#!/bin/sh
# Download music from YouTube and embed extra metadata fetched from
# genius.com.
# Dependencies: yt-dlp, ffmpeg, lyrics (in this repo)

set -e

# This needs some work...
file_name_format='%(track_number)s. %(artist)s - %(album)s - %(track)s.%(ext)s'

[ -z "$1" ] && {
	echo "Download audio with youtube-dl.  Usage: ytmu [urls...]" >&2
	exit 1
}

for url in "$@"; do
	yt_dlp_outfile="$(mktemp ytmu_yt_dlp_tmp.XXX.txt)"
	lyrics_outfile="$(mktemp ytmu_lyrics_tmp.XXX.txt)"
	ffmpeg_infile="$(mktemp ytmu_ffmpeg_tmp.XXX.opus)"
	yt-dlp \
		--extract-audio \
		--audio-format opus \
		--audio-quality 0\
		--embed-metadata \
		--embed-thumbnail \
		--sponsorblock-mark all \
		--output "$file_name_format" \
		--exec "echo {} >$yt_dlp_outfile" \
		"$url"
	file="$(basename "$(cat "$yt_dlp_outfile")")"
	term="${file%%.opus}"
	echo "Fetching lyrics for $term..."
	lyrics "$term" > "$lyrics_outfile" && {
		echo "Adding lyrics to $file..."
		lyrics="$(cat "$lyrics_outfile")"
		mv "$file" "$ffmpeg_infile"
		# Fuck me we're re-encoding here which is slow as
		# balls and loses the cover art because ffmpeg's opus
		# encoder doesn't support cover art yet
		ffmpeg -i "$ffmpeg_infile" -metadata "lyrics=$lyrics" "$file"
	}
	rm -iv "$yt_dlp_outfile" "$lyrics_outfile" "$ffmpeg_infile"
done
